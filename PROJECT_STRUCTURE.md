# Project Organization

This document describes the structure of the Fin-e Trip e-commerce recommendation system with integrated 3D terrain visualization.

## Directory Structure

```
Vectors In Orbit/
â”œâ”€â”€ Core Application Files
â”‚   â”œâ”€â”€ app.py                          Main Streamlit UI (multi-view: Swipe, 3D, Cart)
â”‚   â”œâ”€â”€ search_pipeline.py              Search and ranking engine with timeout handling
â”‚   â”œâ”€â”€ interaction_logger.py           Real-time interaction tracking system
â”‚   â”œâ”€â”€ financial_semantic_viz.py       Financial landscape visualization
â”‚   â”œâ”€â”€ qdrant_setup.py                 Qdrant schema setup
â”‚   â”œâ”€â”€ generate_and_insert_data.py     Data generation and loading
â”‚   â””â”€â”€ requirements.txt                Python dependencies
â”‚
â”œâ”€â”€ terrain_component/                  3D Terrain Visualization Component
â”‚   â”œâ”€â”€ __init__.py                     Streamlit component wrapper
â”‚   â”œâ”€â”€ .env.example                    Environment template
â”‚   â””â”€â”€ frontend/                       React + Three.js + Vite build
â”‚       â”œâ”€â”€ package.json                Node dependencies
â”‚       â”œâ”€â”€ package-lock.json           Dependency lockfile
â”‚       â”œâ”€â”€ vite.config.ts              Vite build config (relative paths)
â”‚       â”œâ”€â”€ tsconfig.json               TypeScript configuration
â”‚       â”œâ”€â”€ tsconfig.node.json          TypeScript config for build tools
â”‚       â”œâ”€â”€ index.html                  React root template
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ main.tsx                React entry point
â”‚       â”‚   â”œâ”€â”€ App.tsx                 Main terrain canvas component
â”‚       â”‚   â”œâ”€â”€ CameraFocus.tsx         Camera focus utilities
â”‚       â”‚   â”œâ”€â”€ ComparisonPanel.tsx     Product comparison panel
â”‚       â”‚   â”œâ”€â”€ ControlIndicators.tsx   UI control indicators
â”‚       â”‚   â”œâ”€â”€ FilterPanel.tsx         Product filtering
â”‚       â”‚   â”œâ”€â”€ KeyboardControls.tsx    WASD keyboard navigation
â”‚       â”‚   â”œâ”€â”€ ProductPreview.tsx      Product details view
â”‚       â”‚   â”œâ”€â”€ QueryPath.tsx           Query path visualization
â”‚       â”‚   â”œâ”€â”€ ScoreBreakdown.tsx      Recommendation score display
â”‚       â”‚   â”œâ”€â”€ SearchPanel.tsx         Search input panel
â”‚       â”‚   â”œâ”€â”€ TourPanel.tsx           Interactive tour guide
â”‚       â”‚   â”œâ”€â”€ WeatherControls.tsx     Environment effects
â”‚       â”‚   â”œâ”€â”€ terrainUtils.ts         Terrain generation utilities
â”‚       â”‚   â”œâ”€â”€ types.ts                TypeScript type definitions
â”‚       â”‚   â””â”€â”€ styles.css              Component styling
â”‚       â”œâ”€â”€ node_modules/               Installed dependencies
â”‚       â”œâ”€â”€ dist/                       Built component (generated by npm run build)
â”‚       â”‚   â”œâ”€â”€ index.html              Component wrapper HTML (relative paths)
â”‚       â”‚   â””â”€â”€ assets/                 Bundled JS/CSS
â”‚       â””â”€â”€ public/                     Static assets
â”‚
â”œâ”€â”€ cf/                                 Financial-Aware Collaborative Filtering
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ fa_cf.py                        FA-CF core algorithm with timeout handling
â”‚
â”œâ”€â”€ explanations/                       Recommendation Explanations
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ generator.py                    Explanation generation logic
â”‚
â”œâ”€â”€ scoring/                            Scoring Components
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ [scoring modules]               Individual scoring functions
â”‚
â”œâ”€â”€ data/                               Product Data
â”‚   â”œâ”€â”€ all_products_payload.json       Combined product data
â”‚   â”œâ”€â”€ products_normalized.json        Normalized product data
â”‚   â”œâ”€â”€ combine_all_data.py             Data combination utility
â”‚   â”œâ”€â”€ amazon/                         Amazon product data
â”‚   â”œâ”€â”€ walmart/                        Walmart product data
â”‚   â”œâ”€â”€ lazada/                         Lazada product data
â”‚   â”œâ”€â”€ e-commerce/                     Other e-commerce data
â”‚   â””â”€â”€ shein/                          Shein product data
â”‚
â”œâ”€â”€ Configuration & Documentation
â”‚   â”œâ”€â”€ .env                            Qdrant credentials (DO NOT COMMIT)
â”‚   â”œâ”€â”€ .env.example                    Environment template
â”‚   â”œâ”€â”€ .gitignore                      Git ignore rules
â”‚   â”œâ”€â”€ .gitattributes                  Line ending normalization
â”‚   â”œâ”€â”€ README.md                       Main project README
â”‚   â”œâ”€â”€ PROJECT_STRUCTURE.md            This file
â”‚   â””â”€â”€ requirements.txt                Python dependencies
â”‚
â””â”€â”€ report/                             Technical Documentation
    â”œâ”€â”€ vectors_in_orbit_technical_report.pdf
    â””â”€â”€ vectors_in_orbit_project_report.pdf
```

## Getting Started

1. **Setup**: Read [README.md](README.md)
2. **Install Python**: `pip install -r requirements.txt`
3. **Build Terrain Component**: 
   ```bash
   cd terrain_component/frontend
   npm install && npm run build
   ```
4. **Configure**: Set up `.env` with Qdrant credentials
5. **Initialize**: `python qdrant_setup.py`
6. **Load Data**: `python generate_and_insert_data.py`
7. **Run UI**: `streamlit run app.py`

## Core Components

### search_pipeline.py
Main recommendation engine that:
- Combines 5 signals with weighted scoring
- Uses Qdrant with 60-second client timeout, 30-second operation timeout
- Gracefully degrades collaborative filtering on timeout
- Returns top-k products ranked by final_score

### interaction_logger.py
Real-time interaction tracking with:
- Non-blocking writes to Qdrant with 30-second timeout
- Financial context validation
- Affordability ratio calculations
- Time-decay for historical data (6-hour half-life for popularity)
- Popularity cache management (5-minute TTL)

### financial_semantic_viz.py
Financial visualization module that:
- Creates 2D UMAP projections of product embeddings
- Determines safety colors (green/orange/red) based on affordability
- Builds terrain payloads for 3D visualization
- Exports products for landscape rendering

### cf/fa_cf.py
Financial-aware collaborative filtering that:
- Respects budget constraints
- Aligns on affordability ratios
- Provides real-time signals via self-boost
- Validates all recommendations with 30-second timeout

### app.py
Streamlit UI with three view modes:

**Swipe & Shop Mode**
- Tinder-like card swiping interface
- Real-time interaction tracking
- Batch loading with discovery queue

**3D Landscape Mode**
- Interactive terrain visualization
- Color-coded product markers
- Safety statistics (green/orange/red counts)
- Keyboard navigation (WASD)
- Product selection with details

**My Cart Mode**
- Shopping cart management
- Item removal
- Total price calculation
- Checkout tracking

### terrain_component/__init__.py
Streamlit component wrapper that:
- Handles Vite-built React component
- Serves from ./dist/ directory with relative paths
- Passes terrain payload to React frontend

### terrain_component/frontend/src/App.tsx
React + Three.js terrain visualization that:
- Renders 3D terrain with products as markers
- Positions products by recommendation score
- Color codes by affordability
- Handles keyboard/mouse controls
- Displays product details on selection

## Data Flow

```
User Input (Sidebar)
    â†“
[app.py] Select view mode, set user context
    â†“
View Mode Router
    â”œâ”€â†’ Swipe & Shop: [app.py â†’ render_swipe_ui()]
    â”œâ”€â†’ 3D Landscape: [app.py â†’ render_3d_landscape_ui()]
    â””â”€â†’ My Cart: [app.py â†’ render_cart_ui()]
    â†“
Search Query
    â†“
[search_pipeline.py] Embed and search
    â”œâ”€ Timeout: 60s client, 30s operations
    â”œâ”€ Graceful degradation on CF timeout
    â†“
[Qdrant Cloud] Vector similarity retrieval
    â†“
[search_pipeline.py] Multi-signal reranking
    â”œâ”€â”€ Semantic matching
    â”œâ”€â”€ Affordability check
    â”œâ”€â”€ Preference alignment
    â”œâ”€â”€ [cf/fa_cf.py] Collaborative filtering (30s timeout)
    â””â”€â”€ [interaction_logger.py] Popularity scores
    â†“
[financial_semantic_viz.py] Build terrain payload
    â”œâ”€ Calculate safety colors
    â”œâ”€ Position products in 3D space
    â””â”€ Generate highlights
    â†“
[app.py] Select display mode
    â”œâ”€â†’ "ðŸ“Š Recommendations": Render product cards
    â”œâ”€â†’ "ðŸ—ºï¸ 3D Explorer": Render terrain canvas
    â””â”€â†’ "ðŸ›’ Cart": Render cart UI
    â†“
[terrain_component] Render 3D canvas (if in 3D mode)
    â”œâ”€ React + Three.js rendering
    â”œâ”€ Product markers and labels
    â”œâ”€ Interactive controls
    â””â”€ Selection handling
    â†“
User Interaction (Click, Swipe, Select)
    â†“
[interaction_logger.py] Log interaction with financial context
    â”œâ”€ Timeout: 30s per operation
    â”œâ”€ Automatic affordability ratio
    â”œâ”€ Financial context validation
    â†“
[Qdrant Cloud] Store in interaction_memory collection
    â†“
Cache invalidation (popularity, trending stats)
    â†“
Next query uses updated signals
```

## View Mode Implementation

### Swipe & Shop (render_swipe_ui)
- Loads 30 products into discovery_queue
- Uses streamlit_swipecards component
- Tracks left/right swipes
- Builds liked_products list
- Allows batch add to cart

### 3D Landscape (render_3d_landscape_ui)
- Extracts products from discovery_queue or search results
- Calls build_search_result_terrain_payload()
- Renders terrain_canvas component
- Handles product selection from 3D
- Displays selected product details

### My Cart (render_cart_ui)
- Displays cart items with images
- Shows item removal UI
- Calculates total price
- Logs purchase on checkout
- Clears cart on completion

## Testing

### Run FA-CF Tests
```bash
python -m tests.test_fa_cf
```

Validates:
- Budget divergence (expensive items get zero boost for low-budget users)
- Financial alignment (similar affordability ratios increase CF scores)
- Real-time interaction (post-purchase scores exceed pre-purchase)
- CF comparison (CF-enabled rankings differ from semantic-only)

### Run Pipeline Demo
```bash
python search_pipeline.py
```

Shows top 5 recommendations with score breakdowns.

## Building and Deploying

### Local Development

```bash
# Build terrain component
cd terrain_component/frontend
npm install
npm run build

# Run Streamlit
cd ../..
streamlit run app.py
```

### Production Setup

```bash
# 1. Navigate to project
cd "c:\Work\Vectors In Orbit"

# 2. Install dependencies
pip install -r requirements.txt

# 3. Build terrain component with optimizations
cd terrain_component/frontend
npm install
npm run build  # Production build (minified, optimized)
cd ../..

# 4. Configure environment
# Edit .env file with Qdrant credentials

# 5. Initialize schema
python qdrant_setup.py

# 6. Load data
python generate_and_insert_data.py

# 7. Run application
streamlit run app.py --server.port 8501 --server.maxUploadSize 200
```

## Terrain Component Build Process

### Development Build
```bash
cd terrain_component/frontend
npm run dev  # Vite dev server with hot reload
```

### Production Build
```bash
cd terrain_component/frontend
npm run build  # Optimized build with relative paths
```

### Build Output
- `dist/index.html` - Component wrapper with relative asset paths (`./assets/...`)
- `dist/assets/index-[hash].js` - Minified JavaScript bundle
- `dist/assets/index-[hash].css` - Minified CSS styles

### Key Configuration (vite.config.ts)
```typescript
export default defineConfig({
  plugins: [react()],
  base: "./",  // Relative paths for Streamlit compatibility
  build: {
    outDir: "dist",
    emptyOutDir: true,
    sourcemap: false
  }
});
```

## Performance Optimization

### Qdrant Timeouts
- **Client timeout**: 60 seconds (cloud operations)
- **Operation timeout**: 30 seconds (scroll, query)
- **Graceful degradation**: CF scores default to 0 on timeout

### Caching Strategy
- **Popularity scores**: 5-minute TTL
- **Trending stats**: 30-second TTL
- **Brand/category options**: Session cache

### Terrain Component
- **Pre-built assets**: Included in dist/
- **Lazy loading**: Component loads only in 3D Landscape mode
- **Relative paths**: Streamlit serves assets without CDN

## Troubleshooting

### Terrain Component Not Loading
```bash
# Rebuild component
cd terrain_component/frontend
npm run build
cd ../..
streamlit run app.py
```

### Slow Recommendations
- Check Qdrant Cloud performance metrics
- Verify GPU acceleration (4-5ms vs 150-200ms for embeddings)
- Increase timeout limits if cloud is slow

### Line Ending Warnings
The `.gitattributes` file normalizes CRLF/LF across platforms:
```
* text=auto
*.js text eol=lf
*.css text eol=lf
*.ts text eol=lf
```

## Security Considerations

- Never commit `.env` file
- Rotate Qdrant API keys monthly
- Validate all user inputs
- Use read-only keys for production frontends
- Monitor collection sizes and query patterns

## Maintenance

### Regular Tasks
- **Weekly**: Check error logs and Qdrant metrics
- **Monthly**: Update Python and Node dependencies
- **Quarterly**: Reindex collections if data grows > 1GB

### Cleanup Commands
```bash
# Remove Python cache
Remove-Item -Recurse -Force __pycache__

# Remove Node modules (to rebuild)
Remove-Item -Recurse -Force terrain_component/frontend/node_modules

# Clean Streamlit cache
Remove-Item -Recurse -Force .streamlit/cache
```

## Architecture Highlights

**3-Layer Design**
1. **Presentation**: Streamlit UI (Python) + React 3D Component
2. **Business Logic**: Search pipeline, CF, scoring modules
3. **Data**: Qdrant Cloud with 4 collections

**Key Features**
- Financial constraints integrated into CF
- Real-time affordability calculations
- Multi-signal scoring with transparent breakdowns
- Non-blocking interaction logging
- 3D terrain visualization of recommendation landscapes
- Graceful timeout handling with degradation

**Scalability**
- Batch embedding processing
- Qdrant Cloud for distributed storage
- Asynchronous interaction writes
- Cache-aware popularity scoring
- Modular component architecture

## Version History

- **v1.0** (Jan 26, 2026): FA-CF v1.0 Production Ready
- **v1.1** (Jan 30, 2026): Added 3D Terrain Visualization, Fixed Timeouts, Improved Error Handling

---

**Project**: Fin-e Trip  
**Latest Version**: Multi-View with 3D Terrain (v1.1)  
**Last Updated**: January 30, 2026  
**Status**: Production Ready
